# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠛⠿⠿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠟⠉⠄⠄⠾⢦⣤⣀⣄⣤⠠⠄⠄⠄⠙⠿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠄⠆⠁⠄⣄⡀⠄⠄⢰⣿⢿⣿⣿⡏⠄⠄⠄⠄⠄⠄⠈⠻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠄⠄⠐⢦⣿⣧⣾⣿⡿⢜⣿⡿⠿⠇⠄⠄⠄⠄⠄⠄⠄⠄⠄⠙⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠿⠧⠐⠃⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⠋⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⢿⣿⣻⡿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⣷⣦⠄⠄⠄⠄⠄⠄⣠⣀⣴⣶⣿⣿⣿⣿⣿⣿⣷⡀⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠈⠹⢿⣿⣿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠄⢀⣠⣶⣿⣿⣿⠛⠛⢉⣹⣿⣿⣿⣿⣿⣿⡄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠛⣿⣿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠄⠄⣠⣤⣀⠹⣿⣷⣏⠄⠡⣉⣡⣭⣿⣿⣿⣿⠄⠄⠄⡜⢥⡱⡀⠄⠄⠄⠄⠄⢰⣿⣿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⡄⠁⠠⠠⣤⠇⣿⣿⣿⣷⣶⣿⣿⣿⣿⣿⣿⡏⠁⠄⠄⢀⢍⣿⡇⠄⠄⠄⢀⣀⡀⢿⣿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣰⣿⣿⣿⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠏⠄⠄⠄⠄⢨⣴⡿⣁⣤⣀⣠⣿⣿⣿⡬⢿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠙⢿⣿⣿⢸⣿⠿⠿⢿⣧⡉⠻⣿⣿⣟⠄⠄⠄⠄⠄⠙⠉⣾⣿⣿⣿⣿⣿⣿⣿⣛⣿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣆⠄⢿⣿⠄⢀⣴⣿⣾⣿⣿⣿⣿⣿⣿⣧⡄⠄⠄⠄⠄⠄⠄⠈⠉⠙⠻⢿⣿⣿⣀⣿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣧⠄⠘⠛⠛⠙⠙⠉⣉⣉⣙⣻⣿⣿⣿⣅⠄⠄⠄⠄⠄⠄⠄⠄⠄⣏⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣦⠄⠄⠄⠄⠉⢩⣿⣿⣿⣿⣿⠿⠋⠄⠄⠄⠄⢠⠄⠄⠄⠄⠄⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⡀⠄⢠⣾⣻⣿⣿⣿⣿⠟⠄⠄⠄⢀⣤⠆⠄⠄⠄⠄⠄⠄⣿⣿⣿⣿⣷⣿⣿⣯⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⡀⠙⠛⠛⠛⠉⠄⠄⢀⣤⡾⠛⠄⠄⠄⠄⠄⠄⠄⠄⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣆⠄⠄⠄⢀⣴⠟⠉⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠙⠻⣿⣿⣿⣷⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣯⠄⠄⠐⠋⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠈⠻⢿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠈⠛⢿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠿⠋⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠛⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠛⠉⠄⠄⠄⣀⡞⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠟⠁⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
# ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠇⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄

# 永远跟党走，心中有党，事业理想。
# ⣿⣿⣿⣿⣿⠟⠋⠄⠄⠄⠄⠄⠄⠄⢁⠈⢻⢿⣿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⠃⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠈⡀⠭⢿⣿⣿⣿⣿
# ⣿⣿⣿⣿⡟⠄⢀⣾⣿⣿⣿⣷⣶⣿⣷⣶⣶⡆⠄⠄⠄⣿⣿⣿⣿
# ⣿⣿⣿⣿⡇⢀⣼⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣧⠄⠄⢸⣿⣿⣿⣿
# ⣿⣿⣿⣿⣇⣼⣿⣿⠿⠶⠙⣿⡟⠡⣴⣿⣽⣿⣧⠄⢸⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣾⣿⣿⣟⣭⣾⣿⣷⣶⣶⣴⣶⣿⣿⢄⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣿⡟⣩⣿⣿⣿⡏⢻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣹⡋⠘⠷⣦⣀⣠⡶⠁⠈⠁⠄⣿⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣍⠃⣴⣶⡔⠒⠄⣠⢀⠄⠄⠄⡨⣿⣿⣿⣿⣿⣿
# ⣿⣿⣿⣿⣿⣿⣿⣦⡘⠿⣷⣿⠿⠟⠃⠄⠄⣠⡇⠈⠻⣿⣿⣿⣿
# ⣿⣿⣿⣿⡿⠟⠋⢁⣷⣠⠄⠄⠄⠄⣀⣠⣾⡟⠄⠄⠄⠄⠉⠙⠻
# ⡿⠟⠋⠁⠄⠄⠄⢸⣿⣿⡯⢓⣴⣾⣿⣿⡟⠄⠄⠄⠄⠄⠄⠄⠄
# ⠄⠄⠄⠄⠄⠄⠄⣿⡟⣷⠄⠹⣿⣿⣿⡿⠁⠄⠄⠄⠄⠄⠄⠄⠄
# china NO.1

import asyncio
from unittest import case
from graia.ariadne import get_running
from graia.broadcast import Broadcast
from graia.ariadne.app import Ariadne
from graia.ariadne.adapter import Adapter
from graia.ariadne.message.chain import MessageChain
from graia.ariadne.message.element import Plain, Image
from graia.ariadne.model import Group, Friend, MiraiSession
from graia.ariadne.message.parser.base import DetectPrefix, GroupMessage
import network, rcon, json

helpMsg = """
欢迎使用蕾姆姬气人的涩图功能
发送awa指令后，系统会自动发送一张涩图
在awa 后面输入关键词，可以获取指定类型的涩图
关键词有：兽耳, setu, 白毛, 星空
"""

loop = asyncio.new_event_loop()

broadcast = Broadcast(loop=loop)
app = Ariadne(
    broadcast=broadcast,
    connect_info=MiraiSession(
        host="http://82.157.63.211:8989",
        # verify_key="HHcRmK233*&%",
        account="1844229700"
    )
)

def fixColor(msg: str):
    # print(msg.split("§"))
    ret = ""
    for i in msg.split("§"):
        if i == "":
            continue
        ret += i[1:]

    return ret

@broadcast.receiver("GroupMessage", decorators=[DetectPrefix("查看在线玩家")])
async def groupMsgListener(app: Ariadne, group: Group, message: MessageChain, groupMsg: GroupMessage):
    if group.id == 921859515:
        with rcon.MCRcon("127.0.0.1", "HHcRmK233*&%", 51419) as rc:
            rawMsg = rc.command("list")
    elif group.id == 747826204:
        with rcon.MCRcon("zyhmc.xyz", "zhangyihao2760", 25575) as rc:
            rawMsg = rc.command("list")
    if rawMsg == "error":
        await app.sendMessage(
            group,
            MessageChain.create("错误:网络错误")
        )
        return
    await app.sendGroupMessage(
        group,
        MessageChain.create(fixColor(rawMsg))
    )

@broadcast.receiver("GroupMessage", decorators=[DetectPrefix("/")])
async def groupMsgListener(app: Ariadne, group: Group, message: MessageChain, groupMsg: GroupMessage):
    id = groupMsg.sender.id
    gid = group.id
    if gid == 921859515:
        if id in [2010882598, 1412754198, 582239460, 201283946]:
            with rcon.MCRcon("127.0.0.1", "HHcRmK233*&%", 51419) as rc:
                resp = rc.command(str(message)[1:])
            # resp = network.connect(("192.168.1.110", 7980), msg=str(message)[0:])
            await app.sendGroupMessage(
                group,
                MessageChain.create(resp)
            )
    elif gid == 747826204:
        if id in [2010882598, 404827312, 3054587546]:
            with rcon.MCRcon("zyhmc.xyz", "zhangyihao2760", 25575) as rc:

                resp = rc.command(str(message[1:]))
            await app.sendGroupMessage(
                group,
                MessageChain.create(resp)
            )

@broadcast.receiver("GroupMessage", decorators=[DetectPrefix("awa")])
async def 涩图(app: Ariadne, group: Group, message: MessageChain, groupMsg: GroupMessage):
    session = get_running(Adapter).session
    if len(str(message)) == 3:
        url = "https://iw233.cn/api.php?sort=random&type=json"
    else:
        if str(message)[4:] == "兽耳":
            url = "https://iw233.cn/api.php?sort=cat&type=json"
        elif str(message)[4:] == "setu":
            url = "http://iw233.fgimax2.fgnwctvip.com/API/Ghs.php?type=json"
        elif str(message)[4:] == "白毛":
            url = "https://iw233.cn/api.php?sort=yin&type=json"
        elif str(message)[4:] == "星空":
            url = "https://iw233.cn/api.php?sort=xing&type=json"
        elif str(message)[4:] == "help":
            await app.sendGroupMessage(
                group,
                MessageChain.create(helpMsg)
            )
        elif str(message)[4:] == "fuck you" or str(message)[4:] == "fuckyou":
            await app.sendGroupMessage(
                group,
                MessageChain.create("Fuck you too")
            )
        else:
            await app.sendGroupMessage(
                group,
                MessageChain.create("嗷呜~没有这个关键词")
            )

    async with session.get(url) as r:
        js = await r.read()
    async with session.get(json.loads(js.decode("utf-8"))["pic"]) as r:
        data = await r.read()
    await app.sendMessage(group, MessageChain.create(
            Image(data_bytes=data)
        ))

# @broadcast.receiver("FriendMessage")
# async def friendMsgListener(app: Ariadne, friend: Friend, message: MessageChain):
#     if friend.id in [2010882598]:
#         if message.

loop.run_until_complete(app.lifecycle())
